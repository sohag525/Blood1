<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Donor App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Hind Siliguri, Poppins, and Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            /* Prioritize Hind Siliguri for Bangla, Poppins for English/numbers, then Inter as fallback */
            font-family: 'Hind Siliguri', 'Poppins', 'Inter', sans-serif; 
            background-color: #f0f2f5;
        }
        .app-container {
            max-width: 420px;
            min-height: 100vh;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }
        .page {
            display: none;
            flex-grow: 1;
            padding: 1rem; 
            overflow-y: auto;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        #sideNav {
            position: fixed;
            top: 0;
            left: -280px; /* Initially hidden off-screen */
            width: 280px;
            height: 100%;
            background-color: white;
            z-index: 1100;
            transition: left 0.3s ease-in-out;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        #sideNav.open {
            left: 0;
        }
        #navOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1099;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #navOverlay.open {
            opacity: 1;
            visibility: visible;
        }

        #toastMessage {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1050; 
            transition: bottom 0.5s ease-in-out;
            pointer-events: none;
        }
        #toastMessage.show {
            bottom: 30px;
        }
        #loadingSpinnerPage2, #loadingSpinnerResults {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .blood-group-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .blood-group-card:hover {
            border-color: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        .blood-group-card .blood-type {
            font-size: 1.875rem;
            font-weight: bold;
            color: #ef4444;
        }
        .blood-group-card .donor-count {
            font-size: 0.875rem;
            color: #4b5563;
        }
        #imageSlideshow {
            width: 100%;
            height: 180px; 
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 1rem; 
            background-color: #e5e7eb;
        }
        .slide-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slide-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .slide-item.active {
            opacity: 1;
        }
        .slide-text-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb;
            color: #6b7280;
            text-align: center;
            padding: 1rem;
        }
        .slide-text-fallback svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
            fill: #9ca3af;
        }
        .slide-text-fallback p {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .header-icon {
            width: 28px;
            height: 28px;
            color: #4B5563;
        }
        .header-icon.text-red-600 {
             color: #dc2626;
        }
        .status-dot {
            width: 10px; 
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
        }
        #statusLegend { 
            display: flex;
            justify-content: space-around; 
            align-items: center;
            margin-bottom: 1rem; 
            font-size: 0.8rem;
            padding: 0.5rem;
            background-color: #f9fafb; 
            border-radius: 0.5rem;
        }
        #statusLegend p {
            display: flex;
            align-items: center;
            color: #4B5563;
        }
        #statusLegend .status-dot {
            margin-right: 6px; 
        }
        @keyframes button-click-animation {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .animate-click {
            animation: button-click-animation 0.2s ease-in-out;
        }
        .faq-item {
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .faq-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .faq-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            cursor: pointer;
            font-weight: 600;
            color: #1f2937;
        }
        .faq-question-header:hover {
            color: #0ea5e9;
        }
        .faq-question-text {
             flex-grow: 1;
             margin-right: 0.5rem;
        }
        .faq-answer {
            color: #4b5563;
            line-height: 1.6;
            padding: 0 0 1rem 0;
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .faq-answer.active {
            display: block;
            max-height: 500px;
        }
        .faq-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease-out;
        }
        .faq-toggle-icon.active {
            transform: rotate(180deg);
        }
        #floatingFaqButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: #0ea5e9;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 900;
            transition: background-color 0.2s ease-in-out, opacity 0.3s, visibility 0.3s;
        }
        #floatingFaqButton:hover {
            background-color: #0284c7;
        }
        #floatingFaqButton svg {
            width: 28px;
            height: 28px;
        }
        .offline-data-message {
            text-align: center;
            padding: 0.5rem;
            background-color: #fffbeb;
            color: #b45309;
            border: 1px solid #fef3c7;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        #locationFilterSelect { 
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem; 
            border: 1px solid #d1d5db; 
            background-color: white;
            font-size: 0.9rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            width: 100%; 
            background-image: url('images/location.png'); 
            background-repeat: no-repeat;
            background-position: 0.75rem center; 
            background-size: 16px 16px; 
            padding-left: 2.5rem; 
        }
        #locationFilterSelect.no-icon { 
            background-image: none;
            padding-left: 0.75rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); 
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 320px;
            text-align: center; 
        }
        .modal-content h3 { 
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .modal-content p {
            font-size: 1rem;
            color: #374151;
            margin-bottom: 0.25rem; 
        }
        .modal-content p#contactActionNumber { 
            font-size: 1.875rem;
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 1.25rem;
            word-break: break-all; 
        }
        .modal-actions {
            display: flex;
            flex-direction: column; 
            gap: 0.75rem; 
            margin-top: 1rem;
        }
        .modal-button {
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; 
            font-size: 0.95rem;
        }
        .modal-button-primary { 
            background-color: #16a34a;
            color: white;
        }
        .modal-button-primary:hover {
            background-color: #15803d;
        }
        .modal-button-secondary { 
            background-color: #3b82f6;
            color: white;
        }
        .modal-button-secondary:hover {
            background-color: #2563eb;
        }
        .modal-button-tertiary { 
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .modal-button-tertiary:hover {
            background-color: #e5e7eb;
        }
        #developerModalImage {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem auto;
            border: 3px solid #ef4444; 
        }
        .developer-social-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem; 
            margin-top: 1rem;
            margin-bottom: 1.5rem; 
        }
        .developer-social-links a {
            display: inline-block;
        }
        .developer-social-links img { 
            width: 32px; 
            height: 32px;
            transition: transform 0.2s ease-in-out;
        }
        .developer-social-links a:hover img {
            transform: scale(1.1);
        }
        .donor-card {
            background-color: white;
            border-radius: 0.75rem; 
            padding: 1rem; 
            margin-bottom: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .donor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            margin-bottom: 0.5rem; 
        }
        .donor-name {
            font-size: 1.125rem; 
            font-weight: 600;
            color: #1f2937; 
        }
        .donor-blood-group {
            font-size: 0.875rem; 
            font-weight: 500;
            padding: 0.125rem 0.5rem; 
            border-radius: 9999px; 
        }
        .donor-blood-group.available {
            color: #059669; 
            background-color: #d1fae5; 
        }
        .donor-blood-group.unavailable {
            color: #ef4444; 
            background-color: #fee2e2; 
        }
        .donor-details p {
            font-size: 0.875rem; 
            color: #4b5563; 
            margin-bottom: 0.25rem; 
            display: flex;
            align-items: center;
        }
        .donor-details img.location-icon { 
            width: 14px;
            height: 14px;
            margin-right: 0.375rem; 
        }
        .contact-donor-button {
            width: 100%;
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            font-weight: 500;
            color: white;
            margin-top: 0.75rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .contact-donor-button.available {
            background-color: #10b981; 
        }
        .contact-donor-button.available:hover {
            background-color: #059669; 
        }
        .contact-donor-button.unavailable {
            background-color: #ef4444; 
        }
        .contact-donor-button.unavailable:hover {
            background-color: #dc2626; 
        }
        .contact-donor-button img { 
            width: 18px;
            height: 18px;
        }
        .donor-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f9fafb; 
            border-radius: 0.5rem;
        }
        .donor-stats svg {
            width: 16px;
            height: 16px;
            margin-right: 0.25rem;
            fill: currentColor;
        }
        
        /* Animation Styles */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-on-load {
            opacity: 0;
            animation-fill-mode: forwards;
            animation-duration: 0.5s;
            animation-timing-function: ease-out;
            animation-name: fadeInUp;
            animation-delay: var(--animation-delay, 0s);
        }
        /* Language Modal Styles */
        .lang-button-container {
            display: flex;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }
        .lang-button {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            background-color: white;
            color: #ef4444;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 1rem;
            font-weight: 500;
        }
        .lang-button.active {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header Section -->
        <header class="flex items-center justify-between p-4 border-b border-gray-200 sticky top-0 bg-white z-50 h-16">
            <div class="flex-1 flex justify-start">
                 <button id="hamburgerButton" aria-label="Menu">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                 </button>
                 <button id="headerBackButton" aria-label="Back" class="hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="header-icon text-red-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 text-center">
                 <h1 id="headerTitle" class="text-lg font-semibold text-gray-800 whitespace-nowrap" data-lang-key="appTitle">Blood Donor</h1>
            </div>
            <div class="flex-1 flex justify-end">
                <button id="developerInfoButton" aria-label="Developer Info">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="header-icon text-red-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Home Page Content -->
        <div id="homePage" class="page active">
            <div id="imageSlideshow"></div>
            <div class="flex-grow flex flex-col justify-start">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2 text-center whitespace-nowrap" data-lang-key="homeSlogan">আপনার রক্তে বাঁচুক প্রাণ</h2>
                <p class="text-gray-600 mb-4 text-center" data-lang-key="homeSubtitle">রক্তদাতা খুঁজুন অথবা রক্তদাতা হিসেবে যোগ দিন</p>
                <button id="findDonorButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md mb-3 flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                    <span data-lang-key="findDonor">রক্তদাতা খুঁজুন</span>
                </button>
                <button id="becomeDonorAppButton" class="w-full border-2 border-red-600 text-red-600 hover:bg-red-50 font-semibold py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" /></svg>
                    <span data-lang-key="becomeDonor">রক্তদাতা হোন</span>
                </button>
            </div>
        </div>

        <!-- Select Blood Group Page Content -->
        <div id="selectBloodGroupPage" class="page">
            <div id="bloodGroupCardsContainer" class="grid grid-cols-2 gap-4 mt-8"></div>
            <div id="loadingSpinnerPage2" class="mt-6"></div>
            <p id="errorMessagePage2" class="mt-4 text-center text-red-600 hidden"></p>
        </div>

        <!-- Donor Results Page Content -->
        <div id="resultsPage" class="page">
            <div class="mb-4" id="locationFilterWrapper"> 
                <select id="locationFilterSelect" name="locationFilter" aria-label="এলাকা অনুযায়ী ফিল্টার করুন"></select>
            </div>
            <div id="donorStats" class="donor-stats">
                <span id="totalDonorsStat" class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" /></svg>
                    <span data-lang-key="totalDonors">মোট রক্তদাতা</span>: <span id="totalDonorsCount">0</span>
                </span>
                <span id="availableDonorsStat" class="flex items-center">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1 text-green-500"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    <span data-lang-key="available">উপলব্ধ</span>: <span id="availableDonorsCount">0</span>
                </span>
            </div>
            <div id="statusLegend" class="mb-4 text-sm text-gray-700">
                <p><span class="status-dot" style="background-color: #10B981;"></span><span data-lang-key="readyToDonate">রক্তদানের জন্য প্রস্তুত</span></p>
                <p><span class="status-dot" style="background-color: #EF4444;"></span><span data-lang-key="recentlyDonated">সম্প্রতি রক্ত দিয়েছেন</span></p>
            </div>
            <div id="loadingSpinnerResults"></div>
            <div id="donorsListContainer"></div>
            <p id="noResultsMessage" class="mt-4 text-center text-gray-600 hidden"></p>
            <p id="errorMessageResults" class="mt-4 text-center text-red-600 hidden"></p>
        </div>

        <!-- FAQ Page Content -->
        <div id="faqPage" class="page">
            <div id="faqContent"></div>
        </div>
    </div>
    <button id="floatingFaqButton" aria-label="সাধারণ জিজ্ঞাসা">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
        </svg>
    </button>
    
    <!-- Modals -->
    <div id="languageModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-semibold" data-lang-key="language">ভাষা</h3>
            <div class="lang-button-container">
                <button class="lang-button" data-lang="en">English</button>
                <button class="lang-button" data-lang="bn">বাংলা</button>
            </div>
        </div>
    </div>
    <div id="contactActionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 data-lang-key="phoneNumber">ফোন নম্বর</h3> 
            <p id="contactActionNumber"></p>
            <div class="modal-actions">
                <button id="contactActionCallButton" class="modal-button modal-button-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 6.75Z" /></svg>
                    <span data-lang-key="call">কল করুন</span>
                </button>
                <button id="contactActionCopyButton" class="modal-button modal-button-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                    <span data-lang-key="copy">কপি করুন</span>
                </button>
                <button id="contactActionCloseButton" class="modal-button modal-button-tertiary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
                    <span data-lang-key="close">বন্ধ করুন</span>
                </button>
            </div>
        </div>
    </div>

    <div id="developerInfoModal" class="modal-overlay">
        <div class="modal-content">
            <h3 data-lang-key="aboutDeveloper">ডেভেলপার সম্পর্কে</h3>
            <img id="developerModalImage" src="images/developer.jpg" alt="Developer Photo" 
                 onerror="this.onerror=null; this.src='https://placehold.co/100x100/cccccc/ffffff?text=Photo'; this.alt='Developer photo not available'">
            <p id="developerName" class="font-semibold text-lg mb-1">Md Shahriya Hasan Sohag</p> 
            <p id="developerTitle" class="text-gray-600" data-lang-key="developerTitle">গ্রাফিক্স ডিজাইনার</p>
            <div class="developer-social-links">
                <a href="https://wa.link/mnyy7m" target="_blank" aria-label="WhatsApp">
                    <img src="images/whatsapp.png" alt="WhatsApp" title="WhatsApp" onerror="this.style.display='none'">
                </a>
                <a href="https://www.facebook.com/shahriyahasan5066/" target="_blank" aria-label="Facebook">
                    <img src="images/facebook.png" alt="Facebook" title="Facebook" onerror="this.style.display='none'">
                </a>
            </div>
            <div class="modal-actions">
                <button id="developerInfoCloseButton" class="modal-button modal-button-tertiary" data-lang-key="close">বন্ধ করুন</button>
            </div>
        </div>
    </div>


    <!-- Toast Message Notification Area -->
    <div id="toastMessage"></div>

    <script>
        // --- CONFIGURATION ---
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBPra3YNf8aSK4j343nemCQyoU3ZeSOsWWvSFclImWj5Zb4mONvrWcYWacOLh3KDizZ12qouuJDMC0/pub?gid=0&single=true&output=csv';
        const googleFormLink = 'https://docs.google.com/forms/d/e/1FAIpQLScawb_WPHqzRSsk9eHhOd23Xmmed9IxZuwQnImA-8ARIgklqA/viewform?usp=dialog';
        const ANIMATION_DELAY = 150; 
        const LOCAL_STORAGE_KEY = 'bloodDonorOfflineData'; 
        const LAST_FETCH_TIMESTAMP_KEY = 'bloodDonorLastFetchTimestamp';
        const LANG_STORAGE_KEY = 'bloodDonorLang';

        // --- LANGUAGE & TRANSLATION ---
        let currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'bn';
        const translations = {
            en: {
                appTitle: "Blood Donor",
                homeSlogan: "Save a Life, Give Blood",
                homeSubtitle: "Find a donor or become one",
                findDonor: "Find Donor",
                becomeDonor: "Become a Donor",
                selectBloodGroup: "Select Blood Group",
                donors: "Blood Donors",
                bloodDonor: "Blood Donor",
                bloodDonors: "Blood Donors",
                totalDonors: "Total Donors",
                available: "Available",
                readyToDonate: "Ready to Donate",
                recentlyDonated: "Recently Donated",
                contact: "Contact",
                phoneNumber: "Phone Number",
                call: "Call",
                copy: "Copy",
                close: "Close",
                aboutDeveloper: "About Developer",
                developerTitle: "Graphics Designer",
                faqTitle: "FAQ",
                language: "Language",
                languageChanged: "Language changed successfully",
                faq: [
                    { q: "1. Who can donate blood?", a: "Answer: Any healthy person between 18 and 60 years old, weighing over 45 kg, can donate blood. However, some specific physical conditions may prevent donation." },
                    { q: "2. How often can one donate blood?", a: "Answer: A healthy man can donate every 3 months, and a healthy woman can donate every 4 months." },
                    { q: "3. What is the blood donation process like?", a: "Answer: Before donating, you will undergo a simple health check, including weight, blood pressure, pulse, and hemoglobin levels. The entire process usually takes 10-15 minutes, but including rest afterwards, it may take 30-40 minutes in total." },
                    { q: "4. Does donating blood make you weak?", a: "Answer: You might feel slightly weak temporarily after donating, but with adequate rest and fluid intake, the body quickly returns to normal. Donating blood does not cause any permanent harm; rather, it is beneficial for health." },
                    { q: "5. What preparations should be taken before donating blood?", a: "Answer: You should get enough sleep the night before and have a healthy breakfast in the morning. Do not donate on an empty stomach. Drink plenty of water and fluids." }
                ],
                noDonorsFound: "No donors found for {group} in {location}.",
                allAreas: "Select Area",
                dataFetchError: "Failed to load donor data. Please check your connection.",
                copied: "Copied: {text}",
                copyError: "Failed to copy.",
                youAreOnline: "You are now online! Updating data...",
                youAreOffline: "⚠️ You are offline. Showing cached data.",
                offlineDataWarning: "⚠️ You are viewing offline data. This may not be the latest information.",
                lastUpdated: "Last updated: {date}"
            },
            bn: {
                appTitle: "ব্লাড ডোনার",
                homeSlogan: "আপনার রক্তে বাঁচুক প্রাণ",
                homeSubtitle: "রক্তদাতা খুঁজুন অথবা রক্তদাতা হিসেবে যোগ দিন",
                findDonor: "রক্তদাতা খুঁজুন",
                becomeDonor: "রক্তদাতা হোন",
                selectBloodGroup: "ব্লাড গ্রুপ নির্বাচন করুন",
                donors: "রক্তদাতা তালিকা",
                bloodDonor: "রক্তদাতা",
                bloodDonors: "রক্তদাতা",
                totalDonors: "মোট রক্তদাতা",
                available: "উপলব্ধ",
                readyToDonate: "রক্তদানের জন্য প্রস্তুত",
                recentlyDonated: "সম্প্রতি রক্ত দিয়েছেন",
                contact: "যোগাযোগ করুন",
                phoneNumber: "ফোন নম্বর",
                call: "কল করুন",
                copy: "কপি করুন",
                close: "বন্ধ করুন",
                aboutDeveloper: "ডেভেলপার সম্পর্কে",
                developerTitle: "গ্রাফিক্স ডিজাইনার",
                faqTitle: "সাধারণ জিজ্ঞাসা",
                language: "ভাষা",
                languageChanged: "ভাষা পরিবর্তন সম্পন্ন হয়েছে",
                 faq: [
                    { q: "১. রক্ত কারা দিতে পারবেন?", a: "উত্তর: ১৮ থেকে ৬০ বছর বয়সী যেকোনো সুস্থ মানুষ, যাদের ওজন ৪৫ কেজির উপরে, তারা রক্ত দিতে পারবেন। তবে কিছু বিশেষ শারীরিক অবস্থায় রক্ত দেওয়া থেকে বিরত থাকতে বলা হয়।" },
                    { q: "২. কতদিন পর পর রক্ত দেওয়া যায়?", a: "উত্তর: একজন সুস্থ পুরুষ প্রতি ৩ মাস পর পর এবং একজন সুস্থ মহিলা প্রতি ৪ মাস পর পর রক্ত দিতে পারবেন।" },
                    { q: "৩. রক্ত দেওয়ার প্রক্রিয়াটি কেমন?", a: "উত্তর: রক্ত দেওয়ার আগে আপনার কিছু সাধারণ স্বাস্থ্য পরীক্ষা করা হবে, যেমন - ওজন, রক্তচাপ, নাড়ির গতি এবং রক্তে হিমোগ্লোবিনের মাত্রা। পুরো প্রক্রিয়াটি সাধারণত ১০-১৫ মিনিট সময় নেয়, তবে রক্তদান পরবর্তী বিশ্রাম সহ মোট ৩০-৪০ মিনিট লাগতে পারে।" },
                    { q: "৪. রক্ত দিলে কি শরীর দুর্বল হয়ে যায়?", a: "উত্তর: রক্ত দেওয়ার পর সাময়িকভাবে সামান্য দুর্বল লাগতে পারে, তবে পর্যাপ্ত বিশ্রাম ও তরল পান করলে শরীর দ্রুত স্বাভাবিক অবস্থায় ফিরে আসে। রক্ত দেওয়ার ফলে শরীরের কোনো স্থায়ী ক্ষতি হয় না, বরং এটি স্বাস্থ্যের জন্য উপকারী।" },
                    { q: "৫. রক্ত দেওয়ার আগে কি ধরনের প্রস্তুতি নেওয়া উচিত?", a: "উত্তর: রক্ত দেওয়ার আগে রাতে পর্যাপ্ত ঘুমানো উচিত এবং সকালে স্বাস্থ্যকর নাস্তা করা উচিত। খালি পেটে রক্ত দেওয়া উচিত নয়। প্রচুর পরিমাণে পানি ও তরল পান করুন।" }
                ],
                noDonorsFound: "{location} অবস্থানে {group} এর জন্য কোন দাতা খুঁজে পাওয়া যায়নি।",
                allAreas: "এলাকা নির্বাচন করুন",
                dataFetchError: "ডেটা লোড করতে ব্যর্থ। আপনার সংযোগ পরীক্ষা করুন।",
                copied: "কপি করা হয়েছে: {text}",
                copyError: "কপি করতে সমস্যা হয়েছে।",
                youAreOnline: "আপনি এখন অনলাইনে আছেন! ডেটা আপডেট করা হচ্ছে...",
                youAreOffline: "⚠️ আপনি এখন অফলাইনে আছেন। সংরক্ষিত ডেটা দেখানো হচ্ছে।",
                offlineDataWarning: "⚠️ আপনি অফলাইন ডেটা দেখছেন। এটি সর্বশেষ তথ্য নাও হতে পারে।",
                lastUpdated: "সর্বশেষ আপডেট: {date}"
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem(LANG_STORAGE_KEY, lang);
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            // Update active button in language modal
            document.querySelectorAll('#languageModal .lang-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            // Update dynamic content
            updateHeaderIcons();
            populateFaq();
            if (currentPageId === 'selectBloodGroup') renderBloodGroupCards();
            if (currentPageId === 'results' && currentSelectedBloodGroup) {
                 displayDonorsForGroup(currentSelectedBloodGroup, locationFilterSelect.value);
            }
        }

        // --- GLOBAL STATE VARIABLES ---
        let allDonors = []; 
        let bloodGroupCounts = {}; 
        const bloodGroups = ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"]; 
        let currentPageId = 'home'; 
        let initialDataFetchFailed = false; 
        let currentSelectedBloodGroup = null; 
        let currentContactForModal = null;  
        let isHandlingPopState = false; 
        
        const slideshowImageSources = [
            { onlineUrl: 'https://raw.githubusercontent.com/sohag525/Blood1/main/image3.jpg', localUrl: 'images/image3.jpg', text: 'You Could Save a Life' },
            { onlineUrl: 'https://raw.githubusercontent.com/sohag525/Blood1/main/image2.jpg', localUrl: 'images/image2.jpg', text: 'Donate Blood Today' },
            { onlineUrl: 'https://raw.githubusercontent.com/sohag525/Blood1/main/image1.jpg', localUrl: 'images/image1.jpg', text: 'Be Someone\'s Hero' }
        ];
        let currentSlideIndex = 0;
        let slideshowInterval; 


        // --- DOM ELEMENT REFERENCES ---
        const pages = { home: null, selectBloodGroup: null, results: null, faq: null };
        const findDonorButton = document.getElementById('findDonorButton');
        const becomeDonorAppButton = document.getElementById('becomeDonorAppButton');
        const floatingFaqButton = document.getElementById('floatingFaqButton');
        const hamburgerButton = document.getElementById('hamburgerButton'); 
        const headerBackButton = document.getElementById('headerBackButton');
        const developerInfoButton = document.getElementById('developerInfoButton'); 
        const headerTitle = document.getElementById('headerTitle');
        const bloodGroupCardsContainer = document.getElementById('bloodGroupCardsContainer');
        const donorsListContainer = document.getElementById('donorsListContainer'); 
        const slideshowContainer = document.getElementById('imageSlideshow');
        const toastMessage = document.getElementById('toastMessage');
        let toastTimeout;
        const loadingSpinnerPage2 = document.getElementById('loadingSpinnerPage2');
        const loadingSpinnerResults = document.getElementById('loadingSpinnerResults');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const errorMessagePage2 = document.getElementById('errorMessagePage2');
        const errorMessageResults = document.getElementById('errorMessageResults');
        const locationFilterWrapper = document.getElementById('locationFilterWrapper');
        const locationFilterSelect = document.getElementById('locationFilterSelect');
        const donorStatsEl = document.getElementById('donorStats');
        const statusLegendEl = document.getElementById('statusLegend');
        const languageModal = document.getElementById('languageModal');
        const contactActionModal = document.getElementById('contactActionModal');
        const contactActionNumber = document.getElementById('contactActionNumber');
        const contactActionCallButton = document.getElementById('contactActionCallButton');
        const contactActionCopyButton = document.getElementById('contactActionCopyButton');
        const contactActionCloseButton = document.getElementById('contactActionCloseButton');
        const developerInfoModal = document.getElementById('developerInfoModal');
        const developerInfoCloseButton = document.getElementById('developerInfoCloseButton');
        const totalDonorsCountEl = document.getElementById('totalDonorsCount');
        const availableDonorsCountEl = document.getElementById('availableDonorsCount');

        // Assign page elements
        pages.home = document.getElementById('homePage');
        pages.selectBloodGroup = document.getElementById('selectBloodGroupPage');
        pages.results = document.getElementById('resultsPage');
        pages.faq = document.getElementById('faqPage');
        
        function animateAndAct(element, callback) {
            if (element) {
                element.classList.add('animate-click');
                setTimeout(() => {
                    callback();
                    element.classList.remove('animate-click'); 
                }, ANIMATION_DELAY);
            } else {
                callback(); 
            }
        }

        function updateHeaderIcons() {
            if (currentPageId === 'home') {
                hamburgerButton.classList.remove('hidden');
                headerBackButton.classList.add('hidden');
                headerTitle.textContent = translations[currentLang].appTitle;
            } else {
                hamburgerButton.classList.add('hidden');
                headerBackButton.classList.remove('hidden');
                if (currentPageId === 'faq') {
                    headerTitle.textContent = translations[currentLang].faqTitle;
                } else if (currentPageId === 'selectBloodGroup') {
                    headerTitle.textContent = translations[currentLang].selectBloodGroup;
                } else if (currentPageId === 'results') {
                    headerTitle.textContent = `${translations[currentLang].donors} (${currentSelectedBloodGroup || ''})`;
                } else {
                    headerTitle.textContent = translations[currentLang].appTitle;
                }
            }
        }
        
        function showPage(pageId, isBackNav = false) {
            currentPageId = pageId;
            Object.values(pages).forEach(page => page.classList.remove('active'));
            if (pages[pageId]) pages[pageId].classList.add('active');
            updateHeaderIcons(); 

            if (floatingFaqButton) {
                floatingFaqButton.style.display = pageId === 'home' ? 'flex' : 'none';
            }


            const elementsToReset = [
                locationFilterWrapper, 
                donorStatsEl, 
                statusLegendEl
            ];
            elementsToReset.forEach(el => {
                if(el) el.classList.remove('animate-on-load');
            });
            document.querySelectorAll('#bloodGroupCardsContainer .blood-group-card, #donorsListContainer .donor-card').forEach(card => card.classList.remove('animate-on-load'));

            if (pageId === 'results') {
                const elementsToAnimate = [locationFilterWrapper, donorStatsEl, statusLegendEl];
                elementsToAnimate.forEach((el, index) => {
                    if (el) {
                        el.classList.add('animate-on-load');
                        el.style.setProperty('--animation-delay', `${index * 100}ms`);
                    }
                });
            }

            if (pageId === 'home') {
                startSlideshow(); 
            } else {
                stopSlideshow(); 
            }

            if (!isBackNav && (history.state?.pageId !== pageId || !history.state?.appState)) {
                history.pushState({ pageId: pageId, appState: true }, '', `#${pageId}`);
            }
        }

        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.appState && event.state.pageId) {
                isHandlingPopState = true; 
                showPage(event.state.pageId, true); 
                isHandlingPopState = false;
            } else if (!event.state && currentPageId !== 'home') { 
                isHandlingPopState = true;
                showPage('home', true);
                history.replaceState({ pageId: 'home', appState: true }, '', '#home'); 
                isHandlingPopState = false;
            }
        });

        function createTextFallbackSlide(slideData) {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.className = 'slide-text-fallback';
            const svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 2H8C4.691 2 2 4.691 2 8v8c0 3.309 2.691 6 6 6h8c3.309 0 6-2.691 6-6V8c0-3.309-2.691-6-6-6zm4 14c0 2.206-1.794 4-4 4H8c-2.206 0-4-1.794-4-4V8c0-2.206 1.794-4 4-4h8c2.206 0 4 1.794 4 4v8z"></path>
                    <path d="M14.293 7.293L11 10.586l-1.293-1.293L8.293 7.707l-4 4V16c0 .827.379 1.561 1 2h13.414A2.993 2.993 0 0 1 18 16.586V9.707l-3.707-2.414zM10 10c1.103 0 2-.897 2-2s-.897-2-2-2-2 .897-2 2 .897 2 2 2z"></path>
                </svg>
            `;
            const textElement = document.createElement('p');
            textElement.textContent = slideData.text; 
            fallbackDiv.innerHTML = svgIcon;
            fallbackDiv.appendChild(textElement);
            return fallbackDiv;
        }

        function initSlideshow() {
            if (!slideshowContainer) return;
            slideshowContainer.innerHTML = ''; 
            if (slideshowImageSources.length === 0) {
                stopSlideshow(); 
                slideshowContainer.appendChild(createTextFallbackSlide({ text: "Slideshow unavailable" }));
                return;
            }

            slideshowImageSources.forEach((slideData) => {
                const slideItemContainer = document.createElement('div');
                slideItemContainer.className = 'slide-item';
                const img = document.createElement('img');
                img.alt = slideData.text;

                const attemptLoadImage = (primaryUrl, fallbackUrl) => {
                    img.src = primaryUrl;
                    img.onerror = () => {
                        if (fallbackUrl) {
                            img.src = fallbackUrl;
                            img.onerror = () => slideItemContainer.appendChild(createTextFallbackSlide(slideData));
                        } else {
                            slideItemContainer.appendChild(createTextFallbackSlide(slideData));
                        }
                    };
                };

                if (navigator.onLine) {
                    attemptLoadImage(slideData.onlineUrl, slideData.localUrl);
                } else {
                    attemptLoadImage(slideData.localUrl, null);
                }

                slideItemContainer.appendChild(img);
                slideshowContainer.appendChild(slideItemContainer);
            });

            const slidesInDom = slideshowContainer.querySelectorAll('.slide-item');
            if (slidesInDom.length > 0) {
                slidesInDom[0].classList.add('active');
                currentSlideIndex = 0;
            }
        }
        
        function nextSlide() {
            if (!slideshowContainer) return;
            const slides = slideshowContainer.querySelectorAll('.slide-item'); 
            if (slides.length <= 1) return; 
            slides[currentSlideIndex].classList.remove('active');
            currentSlideIndex = (currentSlideIndex + 1) % slides.length;
            slides[currentSlideIndex].classList.add('active');
        }

        function startSlideshow() {
            stopSlideshow();    
            initSlideshow();    
            if (slideshowContainer.querySelectorAll('.slide-item').length > 1) {
                slideshowInterval = setInterval(nextSlide, 5000); 
            }
        }

        function stopSlideshow() {
            clearInterval(slideshowInterval);
        }

        function showOfflineDataMessage(pageContainerId) {
            const pageElement = document.getElementById(pageContainerId);
            if (!pageElement) return;

            let existingMessage = pageElement.querySelector('.offline-data-message');
            if (!existingMessage) {
                existingMessage = document.createElement('div');
                existingMessage.className = 'offline-data-message';
                pageElement.insertBefore(existingMessage, pageElement.firstChild);
            }
            
            const lastFetchTimestamp = localStorage.getItem(LAST_FETCH_TIMESTAMP_KEY);
            let messageText = translations[currentLang].offlineDataWarning;
            if (lastFetchTimestamp) {
                try {
                    const date = new Date(lastFetchTimestamp);
                    const formattedDate = date.toLocaleString(currentLang === 'bn' ? 'bn-BD' : 'en-US', { 
                        year: 'numeric', month: 'long', day: 'numeric', 
                        hour: 'numeric', minute: '2-digit', hour12: true 
                    });
                    messageText += ` ${translations[currentLang].lastUpdated.replace('{date}', formattedDate)}`;
                } catch (e) {
                    console.warn("Could not parse last fetch timestamp:", e);
                }
            }
            existingMessage.textContent = messageText;
        }

        function loadDataFromCache(isBackgroundFetch, onlineErrorMsg = null) {
            const cachedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (cachedData) {
                allDonors = JSON.parse(cachedData);
                calculateBloodGroupCounts();
                if (!isBackgroundFetch) {
                    renderBloodGroupCards();
                    populateLocationFilter(); 
                    showOfflineDataMessage('selectBloodGroupPage');
                }
                if (onlineErrorMsg && !isBackgroundFetch) {
                    errorMessagePage2.textContent = `${translations[currentLang].dataFetchError} (${onlineErrorMsg})`; 
                    errorMessagePage2.classList.remove('hidden');
                }
                return true;
            } else {
                allDonors = []; 
                calculateBloodGroupCounts(); 
                if (!isBackgroundFetch) {
                    renderBloodGroupCards(); 
                    populateLocationFilter(); 
                    errorMessagePage2.textContent = translations[currentLang].dataFetchError;
                    errorMessagePage2.classList.remove('hidden');
                }
                initialDataFetchFailed = true; 
                return false;
            }
        }

        async function fetchAndParseData(isBackgroundFetch = false) {
            if (!isBackgroundFetch) { 
                loadingSpinnerPage2.style.display = 'block';
                errorMessagePage2.classList.add('hidden');
            }
            initialDataFetchFailed = false; 

            if (navigator.onLine) { 
                try {
                    const response = await fetch(`${googleSheetCsvUrl}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const csvText = await response.text();
                    allDonors = parseCSV(csvText); 
                    
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allDonors));
                        localStorage.setItem(LAST_FETCH_TIMESTAMP_KEY, new Date().toISOString());
                    } catch (e) {
                        console.warn("Could not save data to localStorage:", e);
                    }

                    calculateBloodGroupCounts();
                    if (!isBackgroundFetch) {
                        renderBloodGroupCards();
                        populateLocationFilter(); 
                    }
                    return true;
                } catch (error) {
                    initialDataFetchFailed = true; 
                    return loadDataFromCache(isBackgroundFetch, error.message);
                } finally {
                    if (!isBackgroundFetch) loadingSpinnerPage2.style.display = 'none';
                }
            } else { 
                if (!isBackgroundFetch) showToast(translations[currentLang].youAreOffline, true);
                return loadDataFromCache(isBackgroundFetch); 
            }
        }

        async function initialBackgroundFetch() {
            if (navigator.onLine) {
                await fetchAndParseData(true); 
            } else {
                loadDataFromCache(true); 
            }
        }

        function parseCSV(data) {
            const donors = [];
            const lines = data.trim().split(/\r?\n/).map(line => line.trim()).filter(line => line);
            if (lines.length <= 1) return donors; 

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim()); 
                if (values.length >= 3) { 
                    donors.push({
                        name: values[0] || "N/A",
                        contact: values[1] || "N/A",
                        bloodGroup: (values[2] || "N/A").toUpperCase(), 
                        lastDonatedDate: values[3] || null, 
                        location: values[4] || "N/A"  
                    });
                }
            }
            return donors;
        }

        function calculateBloodGroupCounts() {
            bloodGroupCounts = {}; 
            bloodGroups.forEach(bg => bloodGroupCounts[bg] = 0); 
            allDonors.forEach(donor => {
                if (bloodGroupCounts.hasOwnProperty(donor.bloodGroup)) {
                    bloodGroupCounts[donor.bloodGroup]++;
                }
            });
        }

        function renderBloodGroupCards() {
            bloodGroupCardsContainer.innerHTML = ''; 
            const donorText = translations[currentLang].bloodDonor;
            const donorsText = translations[currentLang].bloodDonors;
            bloodGroups.forEach((bg, index) => {
                const count = bloodGroupCounts[bg] || 0;
                const card = document.createElement('div');
                card.className = 'blood-group-card animate-on-load';
                card.style.setProperty('--animation-delay', `${index * 50}ms`);
                card.dataset.bloodgroup = bg; 
                card.innerHTML = `
                    <div class="blood-type">${bg}</div>
                    <div class="donor-count">${count} ${count === 1 ? donorText : donorsText}</div>
                `;
                card.addEventListener('click', (e) => {
                    animateAndAct(e.currentTarget, () => handleBloodGroupCardClick(bg));
                });
                bloodGroupCardsContainer.appendChild(card);
            });
        }
        
        function populateLocationFilter() {
            if (!locationFilterSelect) return;
            const currentSelection = locationFilterSelect.value;
            locationFilterSelect.innerHTML = ''; 
            
            const allLocationsOption = document.createElement('option');
            allLocationsOption.value = 'all';
            allLocationsOption.textContent = translations[currentLang].allAreas; 
            locationFilterSelect.appendChild(allLocationsOption);
            
            const uniqueLocations = [...new Set(allDonors.map(donor => donor.location).filter(loc => loc && loc !== "N/A"))].sort();
            uniqueLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilterSelect.appendChild(option);
            });
            locationFilterSelect.value = currentSelection;
            locationFilterSelect.classList.toggle('no-icon', locationFilterSelect.options.length <= 1);
        }

        function handleBloodGroupCardClick(bloodGroup) {
            currentSelectedBloodGroup = bloodGroup;
            populateLocationFilter(); 
            if(locationFilterSelect) locationFilterSelect.value = 'all'; 
            
            showPage('results'); 
            displayDonorsForGroup(bloodGroup, 'all'); 
        }

        function isDonorAvailable(lastDonatedDateStr) {
            if (!lastDonatedDateStr) return true;
            try {
                let parts = lastDonatedDateStr.split('/'); 
                let lastDonatedDate = parts.length === 3 ? new Date(parts[2], parts[0] - 1, parts[1]) : new Date(lastDonatedDateStr);
                if (isNaN(lastDonatedDate.getTime())) return true;
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(new Date().getMonth() - 3); 
                return lastDonatedDate <= threeMonthsAgo; 
            } catch (e) {
                return true; 
            }
        }

        function showContactActionModal(contactNumber) {
            currentContactForModal = contactNumber; 
            if(contactActionNumber) contactActionNumber.textContent = contactNumber;
            if(contactActionModal) contactActionModal.classList.add('active'); 
        }

        function hideContactActionModal() {
            if(contactActionModal) contactActionModal.classList.remove('active'); 
            currentContactForModal = null; 
        }
        
        function showDeveloperInfoModal() {
            if (!developerInfoModal) return;
            const developerModalImageEl = document.getElementById('developerModalImage');
            const onlineDevImageUrl = 'https://raw.githubusercontent.com/sohag525/Blood1/main/image4.jpg';
            const localDevImageUrl = 'images/developer.jpg';
            
            const attemptLoadDevImage = (primarySrc, fallbackSrc) => {
                developerModalImageEl.src = primarySrc;
                developerModalImageEl.onerror = () => { if (fallbackSrc) developerModalImageEl.src = fallbackSrc; };
            };
            if (navigator.onLine) attemptLoadDevImage(onlineDevImageUrl, localDevImageUrl);
            else attemptLoadDevImage(localDevImageUrl, 'https://placehold.co/100x100/cccccc/ffffff?text=Photo');
            
            developerInfoModal.classList.add('active'); 
        }


        function hideDeveloperInfoModal() {
            if(developerInfoModal) developerInfoModal.classList.remove('active');
        }

        function displayDonorsForGroup(selectedGroup, selectedLocation = 'all') { 
            if(loadingSpinnerResults) loadingSpinnerResults.style.display = 'block'; 
            if(donorsListContainer) donorsListContainer.innerHTML = ''; 
            if(noResultsMessage) noResultsMessage.classList.add('hidden'); 
            if(errorMessageResults) errorMessageResults.classList.add('hidden'); 
            
            const resultsPageElement = document.getElementById('resultsPage');
            if (resultsPageElement.querySelector('.offline-data-message')) {
                resultsPageElement.querySelector('.offline-data-message').remove();
            }

            if (!navigator.onLine && localStorage.getItem(LOCAL_STORAGE_KEY)) {
                showOfflineDataMessage('resultsPage');
            }

            if (initialDataFetchFailed && allDonors.length === 0) {
                if(errorMessageResults) {
                    errorMessageResults.textContent = translations[currentLang].dataFetchError;
                    errorMessageResults.classList.remove('hidden');
                }
                if(loadingSpinnerResults) loadingSpinnerResults.style.display = 'none';
                return;
            }

            let finalFilteredDonors = allDonors.filter(donor => donor.bloodGroup === selectedGroup && (selectedLocation === 'all' || donor.location === selectedLocation));
            
            finalFilteredDonors.forEach(donor => donor.isAvailable = isDonorAvailable(donor.lastDonatedDate));
            if(totalDonorsCountEl) totalDonorsCountEl.textContent = finalFilteredDonors.length; 
            if(availableDonorsCountEl) availableDonorsCountEl.textContent = finalFilteredDonors.filter(d => d.isAvailable).length;
            finalFilteredDonors.sort((a, b) => (b.isAvailable - a.isAvailable) || a.name.localeCompare(b.name));

            if (finalFilteredDonors.length === 0) {
                if(noResultsMessage) {
                    noResultsMessage.textContent = translations[currentLang].noDonorsFound
                        .replace('{group}', selectedGroup)
                        .replace('{location}', selectedLocation === 'all' ? translations[currentLang].allAreas : selectedLocation);
                    noResultsMessage.classList.remove('hidden');
                }
            } else {
                finalFilteredDonors.forEach((donor, index) => {
                    const card = document.createElement('div');
                    card.className = 'donor-card animate-on-load';
                    card.style.setProperty('--animation-delay', `${index * 100}ms`);

                    card.innerHTML = `
                        <div class="donor-card-header">
                            <h4 class="donor-name">${donor.name}</h4>
                            <div class="flex items-center">
                                <span class="donor-blood-group ${donor.isAvailable ? 'available' : 'unavailable'}">${donor.bloodGroup}</span>
                            </div>
                        </div>
                        <div class="donor-details">
                            <p>
                                <img src="images/location.png" alt="Location" class="location-icon w-4 h-4 mr-1.5" onerror="this.style.display='none'">
                                ${donor.location || 'N/A'}
                            </p>
                        </div>
                        <button class="contact-donor-button ${donor.isAvailable ? 'available' : 'unavailable'}">
                             <img src="images/telephone.png" alt="Call" class="w-5 h-5 mr-2" onerror="this.style.display='none'"> 
                            <span data-lang-key="contact">${translations[currentLang].contact}</span> 
                        </button>
                    `;
                    card.querySelector('.contact-donor-button').addEventListener('click', (e) => {
                        animateAndAct(e.currentTarget, () => showContactActionModal(donor.contact));
                    });
                    donorsListContainer.appendChild(card);
                });
            }
            if(loadingSpinnerResults) loadingSpinnerResults.style.display = 'none'; 
        }
        
        function showToast(message, isWarning = false) {
            toastMessage.textContent = message;
            toastMessage.classList.add('show');
            clearTimeout(toastTimeout); 
            toastTimeout = setTimeout(() => toastMessage.classList.remove('show'), 3000); 
        }

         function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(translations[currentLang].copied.replace('{text}', text));
            }).catch(() => {
                showToast(translations[currentLang].copyError, true);
            });
        }

        function populateFaq() {
            const faqContainer = document.getElementById('faqContent');
            faqContainer.innerHTML = '';
            translations[currentLang].faq.forEach(item => {
                const faqItem = document.createElement('div');
                faqItem.className = 'faq-item';
                faqItem.innerHTML = `
                    <div class="faq-question-header">
                        <span class="faq-question-text">${item.q}</span>
                        <svg class="faq-toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="faq-answer"><p>${item.a}</p></div>
                `;
                faqContainer.appendChild(faqItem);
            });
            initializeFaqAccordion();
        }

        function initializeFaqAccordion() {
            document.querySelectorAll('#faqContent .faq-question-header').forEach(header => {
                header.addEventListener('click', () => {
                    const answer = header.nextElementSibling; 
                    const icon = header.querySelector('.faq-toggle-icon'); 
                    answer.classList.toggle('active');
                    icon.classList.toggle('active');
                });
            });
        }

        function toggleLanguageModal() {
            const languageModal = document.getElementById('languageModal');
            languageModal.classList.toggle('active');
        }

        // --- EVENT LISTENERS ---
        hamburgerButton.addEventListener('click', toggleLanguageModal);
        
        document.querySelectorAll('#languageModal .lang-button').forEach(button => {
            button.addEventListener('click', () => {
                const lang = button.dataset.lang;
                if (lang !== currentLang) {
                    setLanguage(lang);
                    showToast(translations[lang].languageChanged);
                }
                toggleLanguageModal();
            });
        });
        
        document.getElementById('languageModal').addEventListener('click', (e) => {
             if (e.target.id === 'languageModal') {
                toggleLanguageModal();
             }
        });

        findDonorButton.addEventListener('click', (e) => {
            animateAndAct(e.currentTarget, async () => {
                showPage('selectBloodGroup');
                await fetchAndParseData(); 
            });
        });

        becomeDonorAppButton.addEventListener('click', () => window.open(googleFormLink, '_blank'));
        
        floatingFaqButton.addEventListener('click', (e) => {
            animateAndAct(e.currentTarget, () => showPage('faq'));
        });


        headerBackButton.addEventListener('click', (e) => {
            animateAndAct(e.currentTarget, () => history.back());
        });
        
        developerInfoButton.addEventListener('click', (e) => {
            animateAndAct(e.currentTarget, showDeveloperInfoModal);
        });
        
        window.addEventListener('online', async () => {
            if(currentPageId === 'home') startSlideshow(); 
            showToast(translations[currentLang].youAreOnline); 
            const refreshed = await fetchAndParseData(true); 
            if (refreshed && (currentPageId === 'selectBloodGroup' || currentPageId === 'results')) {
                setLanguage(currentLang);
            }
        });

        window.addEventListener('offline', () => {
             if(currentPageId === 'home') startSlideshow(); 
             showToast(translations[currentLang].youAreOffline, true); 
             if (currentPageId === 'selectBloodGroup' || currentPageId === 'results') {
                showOfflineDataMessage(currentPageId + 'Page');
             }
        });

        if (locationFilterSelect) {
            locationFilterSelect.addEventListener('change', (e) => {
                if (currentSelectedBloodGroup) { 
                    displayDonorsForGroup(currentSelectedBloodGroup, e.target.value);
                }
            });
        }

        contactActionCallButton.addEventListener('click', () => {
            if (currentContactForModal) window.location.href = `tel:${currentContactForModal}`; 
            hideContactActionModal();
        });

        contactActionCopyButton.addEventListener('click', () => {
            if (currentContactForModal) copyToClipboard(currentContactForModal); 
            hideContactActionModal();
        });

        contactActionCloseButton.addEventListener('click', hideContactActionModal);
        contactActionModal.addEventListener('click', (e) => {
            if (e.target === contactActionModal) hideContactActionModal();
        });

        developerInfoCloseButton.addEventListener('click', hideDeveloperInfoModal);
        developerInfoModal.addEventListener('click', (e) => {
            if (e.target === developerInfoModal) hideDeveloperInfoModal();
        });

        // --- INITIALIZATION & SERVICE WORKER ---
        document.addEventListener('DOMContentLoaded', () => {
            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'blood-donor-cache-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap',
                        'images/image1.jpg',
                        'images/image2.jpg',
                        'images/image3.jpg',
                        'images/location.png',
                        'images/telephone.png',
                        'images/developer.jpg',
                        'images/whatsapp.png',
                        'images/facebook.png'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Opened cache');
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request).then(
                                        (response) => {
                                            if(!response || response.status !== 200 || response.type !== 'basic') {
                                                return response;
                                            }
                                            const responseToCache = response.clone();
                                            caches.open(CACHE_NAME)
                                                .then(cache => {
                                                    cache.put(event.request, responseToCache);
                                                });
                                            return response;
                                        }
                                    );
                                })
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            }


            setLanguage(currentLang);
            history.replaceState({ pageId: 'home', appState: true }, '', '#home');
            initialBackgroundFetch().then(() => {
                if (currentPageId === 'results') populateLocationFilter();
            }); 
            showPage('home'); 
        });
    </script>
</body>
</html>
